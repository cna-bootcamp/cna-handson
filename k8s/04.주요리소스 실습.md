# 쿠버네티스 주요 리소스 실습

## 샘플 오브젝트 생성
이전 '03.kubectl 실습'때 만든 config.yaml을 이용하여 아래 명령으로 오브젝트들을 생성합니다. 
```
kubectl apply -f config.yaml
```

--- 

## 서비스  
- Headless 서비스 만들기  
아래 내용으로 headless 정의 yaml 파일을 'headless.yaml'로 만듭니다.   
기존 서비스 정의와 달라진 점은 metadata.name을 변경한 것과 spec.clusterIP=None 이 추가된것뿐입니다.   
```
apiVersion: v1
kind: Service
metadata:
  name: config-headless
  namespace: gappa
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: config
  ports:
    - name: config
      port: 18080
      targetPort: 18080

```

headless 서비스를 생성합니다.  
```
k apply -f headless.yaml  
```

파드 수를 늘립니다.  
```
$ k scale deploy config --replicas=2
```

curl 파드로 들어가서 nslookup으로 기존 서비스와 headless 서비스를 조회해 봅니다.   
결과값 차이를 보시면 headless 서비스는 파드의 각 주소를 리턴하는걸 알 수 있습니다.   
```
$ k exec -it curl -- sh
nslookup config
nslookup config-headless
```

- nodePort
아래 내용으로 nodeport.yaml 파일을 만듭니다.   
namespace는 본인 것으로 바꿉니다.  
여러 사람이 하는 경우 외부 포트가 충돌 나므로 31080값을 중복되지 않는 값으로 바꿔서 정의 합니다.   
```
apiVersion: v1
kind: Service
metadata:
  name: config-nodeport
  namespace: gappa
spec:
  type: NodePort
  selector:
    app: config
  ports:
    - name: config
      port: 18080
      targetPort: 18080
      nodePort: 31080
``` 

서비스를 생성하고 외부 포트를 확인합니다.  
```
k apply -f nodeport.yaml
k get svc
```

브라우저에서 http://{퍼블릭IP}:{외부포트}/member-service/default로 접근해 봅니다.   

---

## ConfigMap
- from-file과 from-env-file

아래 내용으로 imgreg.conf 파일을 만듭니다.   
```
registry=docker.io 
organization=hiondal
repo=member
```

from-file로 ConfigMap 'cm1'을 만듭니다.  
```
k create cm cm1 --from-file imgreg.conf
```

from-env-file로 ConfigMap 'cm2'를 만듭니다.  
```
k create cm cm2 --from-env-file imgreg.conf
```

각 ConfigMap 객체의 내용을 확인해 봅니다.  
```
k describe cm cm1
k describe cm cm2
```

> Tip: k8s 대시보드에서 더 쉽게 오브젝트 정보를 볼 수 있음: http://43.200.12.214:31000

- ConfigMap을 볼륨 마운트 하기  

아래 내용으로 cmvol.yaml 파일을 만듭니다.   

```
apiVersion: v1
kind: ConfigMap 
metadata:
  name: cmvol
data:
  cm.conf: |
    {
      name: "busybox"
      description: "test config"
    }
  imgreg.conf: |+
    registry=docker.io 
    organization=hiondal
    repo=member
```

ConfigMap을 생성합니다.  
```
k apply -f cmvol.yaml
```

config.yaml을 열어 Deployment정의에 아래와 같이 volumeMounts와 volumes항목을 추가합니다.  
> 주의: volumeMounts는 containers.resources와 같은 레벨이고,   
> vaolumes는 containers와 같은 레벨입니다.  

```
{중략}
      containers: 
      {중략}
          resources: 
          {중략}
          volumeMounts:
            - name: myconfig
              mountPath: /home/config
      volumes:
        - name: myconfig
          configMap:
            name: cmvol

```

config.yaml을 다시 적용하여 파드를 재생성합니다.  
```
k apply -f config.yaml 
```

새 파드 생성 후 아래 명령으로 마운트가 제대로 되었는지 확인합니다.   
파드명은 본인 것으로 바꿔야 합니다.   
```
k exec -it config-776bfbc885-vpm69 -- ls -al /home/config
k exec -it config-776bfbc885-vpm69 -- cat /home/config/cm.conf
```

ConfigMap을 변경하면 파드안에 동적으로 반영되는지 확인하겠습니다.   
cmvol.yaml파일을 data 밑의 파일 내용을 변경합니다.   
예를 들어 'name: "busybox"'을 'name: "busybox2"'으로 변경합니다.   
그리고 kubectl apply -f cmvol.yaml로 적용합니다.   

약 1분 후에 변경한 파일의 내용을 확인해 봅니다.   
```
k exec -it config-776bfbc885-vpm69 -- cat /home/config/cm.conf
```

- Image Pull Secret 생성   

Docker Hub의 인증 시크릿 객체를 만듭니다.   
```
kubectl create secret docker-registry dockerhub \
--docker-server=docker.io \
--docker-username=hiondal \
--docker-password=11111 
```

---




