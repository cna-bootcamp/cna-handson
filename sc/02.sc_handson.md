# Spring Cloud Gateway 업그레이드 


### Loadbalancer 변경
기본 로드밸런스를 Ribbon에서 Spring Cloud Load Balancer로 변경합니다.  

build.gralde에 Load Balancer 라이브러리, L/B캐시 Caffeine라이브러리를 추가합니다. 
 

```
dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'

    //-- 기본 L/B인 Ribbon대신 Load Balancer사용
    implementation 'org.springframework.cloud:spring-cloud-starter-loadbalancer'
    //-- Load Balancer가 사용할 캐시를 Caffeine으로 변경
    implementation 'com.github.ben-manes.caffeine:caffeine'
    implementation 'org.springframework.boot:spring-boot-starter-cache'

}
```

application.yml의 spring 밑에 L/B 설정을 추가합니다. 
```
spring:
  application:
    name: scg
  jwt:
    secret: ${JWT_SECRET:8O2HQ13etL2BWZvYOiWsJ5uWFoLi6NBUG8divYVoCgtHVvlk3dqRksMl16toztDUeBTSIuOOPvHIrYq11G2BwQ==}
  # -- Load banancer 설정 : 기본 L/B인 Ribbon비활성화
  cloud.loadbalancer:
    ribbon.enabled: false
    cache.enabled: true

  # -- Load Balancer의 캐시 타입 설정
  cache.type: caffeine
```

com.sc.scg밑에 CacheConfig 클래스를 추가합니다.  
```
import com.github.benmanes.caffeine.cache.Caffeine;
import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cache.caffeine.CaffeineCacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(caffeineCacheBuilder());
        return cacheManager;
    }

    Caffeine<Object, Object> caffeineCacheBuilder() {
        return Caffeine.newBuilder()
                .initialCapacity(100)   //초기 캐시 크기: 몇개의 항목을 수용할 것인가?
                .maximumSize(500)       //최대 캐시 크기
                .expireAfterAccess(10, TimeUnit.MINUTES)    //캐시 제거 기준 시간: 마지막 접근 후 몇분동안 접근 없으면 삭제할 것인가?
                .weakKeys()     //캐시에 저장되는 각 항목에 대해 약한 참조로 설정. 어떤 항목을 참조하는 외부 객체가 사라지면 캐시에서도 그 항목이 사라지게 함
                .recordStats(); //캐시 통계 기록
    }
}
```

### 







> 그외 SCG의 application.yml 설정은 [Spring Cloud Gateway](https://happycloud-lee.tistory.com/218)를 참조하십시오.   
