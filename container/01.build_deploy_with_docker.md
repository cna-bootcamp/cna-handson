# Docker를 이용한 Build & Deploy

## network 객체 생성: container간 통신 목적  
  ```
  docker network create subride
  ```

## MySQL 실행  
기존 MySQL 삭제  
```
docker stop mysql
docker rm mysql
```

network옵션 추가하여 다시 실행  
```
docker run -d --name mysql -p 3306:3306 \
--network subride \
-e MYSQL_ROOT_PASSWORD=P@ssw0rd$ \
mysql
```   

## Build&Run: subride-front
- 소스 클론 후 vscode에서 subride-front 폴더 오픈    
  ```
  git clone https://github.com/hiondal/subride-front.git
  ```
- components/api.js 수정

  환경변수에서 SCG주소를 얻도록 수정함  
  ```
  const API_BASE_URL = process.env.REACT_APP_API_BASE_URL || "http://localhost:19080";
  const BASE_URL = `${API_BASE_URL}/api/subrecommend`; // 백엔드 서버 주소에 맞게 수정

  ```

- Build관련 파일 작성  
  - 최상위 디렉토리에 'buildfile' 디렉토리 작성  
  - Dockerfile 작성
    buildfile 디렉토리 하위에 'Dockerfile_react_express'을 생성하고,  
    [Handson 교재](https://github.com/cna-bootcamp/cna-handson.git)의  
    container/buildfile/Dockerfile_react_express의 내용 복사
  - 'server.js' 작성
    buildfile 디렉토리 하위에 'container/buildfile/server.js' 내용 복사하여 작성   

- Dockerfile의 Argument이해  
  ```
  # Arguments
  ARG PROJECT_FOLDER
  ARG BUILD_FOLDER
  ARG EXPORT_PORT
  ENV PORT ${EXPORT_PORT}

  # API G/W 호출 주소 환경변수 셋팅 
  ARG REACT_APP_API_BASE_URL
  ENV REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL}
  ```

  - PROJECT_FOLDER: 소스가 있는 최상위 디렉토리 경로
  - BUILD_FOLDER: build 관련 파일이 있는 디렉토리. 즉, 'buildfile'
  - EXPORT_PORT: 서버를 실행할 포트
  - REACT_APP_API_BASE_URL: SCG의 주소

- build image
  - vscode에서 터미널을 오픈  
  - image build 명령 입력  
    ```
    docker build -f buildfile/Dockerfile_react_express \
    -t docker.io/hiondal/subride-front:1.0.0 \
    --build-arg PROJECT_FOLDER=. \
    --build-arg BUILD_FOLDER=buildfile \
    --build-arg REACT_APP_API_BASE_URL=http://localhost:19080 \
    .
    ```
- Run container
  ```
  docker run -d --rm --name subride-front -p 3000:3000 hiondal/subride-front:1.0.0
  ```

---

## Build&Run: sc
- 소스 클론 후 IntelliJ에서 sc 프로젝트 오픈  
  ```
  git clone https://github.com/hiondal/sc.git
  ```
  
- Build관련 파일 작성  
  - 최상위 디렉토리에 'buildfile' 디렉토리 작성  
  - Dockerfile 작성
    buildfile 디렉토리 하위에 'Dockerfile_java'을 생성하고,  
    [Handson 교재](https://github.com/cna-bootcamp/cna-handson.git)의  
    container/buildfile/Dockerfile_java의 내용 복사
  
- Dockerfile의 Argument이해
  - ARTIFACTORY_FILE: 실행 jar 파일명  
  - BUILD_LIB_DIR: 실행 jar파일이 있는 디렉토리. build/libs로 지정하면 됨  

- build jar
  - jar파일명 지정: 각 프로젝트의 build.gradle에 archiveFileName 지정
    아래는 config 프로젝트의 예시임     
    ```
    bootJar {
      enabled = true
      archiveFileName = "config.jar"
    }
    ```
    Eureka는 eureka.jar, SCG는 scg.jar로 지정  

  - build jar: intelliJ에서 터미널을 오픈하고 아래 명령 입력   
    ```
    ./gradlew config:build
    ./gradlew eureka:build
    ./gradlew scg:build
    ```

    각 프로젝트의 build/libs 디렉토리 밑에 지정한 jar파일이 생성되는지 확인   

- build image
  - image build 명령 입력  
  아래는 config 서비스의 image를 만드는 명령임  
  ```
  docker build -f buildfile/Dockerfile_java \
  -t docker.io/hiondal/config:1.0.0 \
  --build-arg ARTIFACTORY_FILE=config.jar \
  --build-arg BUILD_LIB_DIR=build/libs \
  config
  ```
  다른 서비스도 image를 만듭니다.   

- Run container
  기존에 서비스를 실행했다면 중지합니다.  

  Config서버
  ```
  docker run -d --rm --name config -p 9001:9001 \
  --network subride \
  hiondal/config:1.0.0
  ```

  Eureka서버
  ```
  docker run -d --rm --name eureka1 -p 8761:8761 \
  --network subride \
  -e spring.profiles.active=eureka1 \
  -e eureka.instance.hostname=eureka1 \
  -e eureka.instance.instanceId=eureka1 \
  -e eureka.client.serviceUrl.defaultZone=http://eureka2:8762/eureka \
  hiondal/eureka:1.0.0
  ```
  ```
  docker run -d --rm --name eureka2 -p 8762:8762 \
  --network subride \
  -e spring.profiles.active=eureka2 \
  -e eureka.instance.hostname=eureka2 \
  -e eureka.instance.instanceId=eureka2 \
  -e eureka.client.serviceUrl.defaultZone=http://eureka1:8761/eureka \
  hiondal/eureka:1.0.0
  ```  

  SCG서버
  ```
  docker run -d --rm --name scg -p 19080:19080 \
  --network subride \
  -e eureka.client.serviceUrl.defaultZone=http://eureka2:8762/eureka,http://eureka2:8762/eureka \
  hiondal/scg:1.0.0
  ```

---

## Build&Run: subrecommend   
- 소스 클론 후 IntelliJ에서 sc 프로젝트 오픈  
  ```
  git clone https://github.com/hiondal/subrecommend.git
  ```
- Build관련 파일 작성  
  - 최상위 디렉토리에 'buildfile' 디렉토리 작성  
  - Dockerfile 작성
    buildfile 디렉토리 하위에 'Dockerfile_java'을 생성하고,  
    [Handson 교재](https://github.com/cna-bootcamp/cna-handson.git)의  
    container/buildfile/Dockerfile_java의 내용 복사
  
- Dockerfile의 Argument이해
  - ARTIFACTORY_FILE: 실행 jar 파일명  
  - BUILD_LIB_DIR: 실행 jar파일이 있는 디렉토리. build/libs로 지정하면 됨  

- build jar
  - jar파일명 지정: build.gradle에 archiveFileName 지정  
    ```
    bootJar {
      enabled = true
      archiveFileName = "subrecommend.jar"
    }
    ```
  - build jar: intelliJ에서 터미널을 오픈하고 아래 명령 입력   
    ```
    ./gradlew subrecommend-infra:build
    ```

    build/libs 디렉토리 밑에 subrecommend.jar파일이 생성되는지 확인   

- build image
  - image build 명령 입력  
  ```
  docker build -f buildfile/Dockerfile_java \
  -t docker.io/hiondal/subrecommend:1.0.0 \
  --build-arg ARTIFACTORY_FILE=subrecommend.jar \
  --build-arg BUILD_LIB_DIR=build/libs \
  subrecommend-infra
  ```

- Run container
  기존에 서비스를 실행했다면 중지합니다.  

  ```
  docker run -d --rm --name subrecommend -p 18081:18081 \
  --network subride \
  -e CONFIG_SERVER_FQDN=http://config:9001 \
  -e eureka.instance.instanceId=http://subrecommend:18081 \
  -e eureka.client.serviceUrl.defaultZone=http://eureka2:8762/eureka,http://eureka2:8762/eureka \
  -e "DB_URL=jdbc:mysql://mysql:3306/subrecommend?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true" \
  hiondal/subrecommend:1.0.0
  ```
